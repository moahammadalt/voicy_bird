/*! p5.sound.js v0.2.16 2015-11-03 */
(function(a,b){if(typeof define==="function"&&define.amd){define("p5.sound",["p5"],function(c){(b(c))})}else{if(typeof exports==="object"){b(require("../p5"))}else{b(a.p5)}}}(this,function(E){var r;r=function(){(function(R,Q,P){Q=Q||{};"use strict";function S(T){if(!T){return}if(!T.setTargetAtTime){T.setTargetAtTime=T.setTargetValueAtTime}}if(window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")){window.AudioContext=webkitAudioContext;if(!AudioContext.prototype.hasOwnProperty("createGain")){AudioContext.prototype.createGain=AudioContext.prototype.createGainNode}if(!AudioContext.prototype.hasOwnProperty("createDelay")){AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode}if(!AudioContext.prototype.hasOwnProperty("createScriptProcessor")){AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode}if(!AudioContext.prototype.hasOwnProperty("createPeriodicWave")){AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable}AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain;AudioContext.prototype.createGain=function(){var T=this.internal_createGain();S(T.gain);return T};AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay;AudioContext.prototype.createDelay=function(T){var U=T?this.internal_createDelay(T):this.internal_createDelay();S(U.delayTime);return U};AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource;AudioContext.prototype.createBufferSource=function(){var T=this.internal_createBufferSource();if(!T.start){T.start=function(U,W,V){if(W||V){this.noteGrainOn(U||0,W,V)}else{this.noteOn(U||0)}}}else{T.internal_start=T.start;T.start=function(U,W,V){if(typeof V!=="undefined"){T.internal_start(U||0,W,V)}else{T.internal_start(U||0,W||0)}}}if(!T.stop){T.stop=function(U){this.noteOff(U||0)}}else{T.internal_stop=T.stop;T.stop=function(U){T.internal_stop(U||0)}}S(T.playbackRate);return T};AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor;AudioContext.prototype.createDynamicsCompressor=function(){var T=this.internal_createDynamicsCompressor();S(T.threshold);S(T.knee);S(T.ratio);S(T.reduction);S(T.attack);S(T.release);return T};AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter;AudioContext.prototype.createBiquadFilter=function(){var T=this.internal_createBiquadFilter();S(T.frequency);S(T.detune);S(T.Q);S(T.gain);return T};if(AudioContext.prototype.hasOwnProperty("createOscillator")){AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator;AudioContext.prototype.createOscillator=function(){var T=this.internal_createOscillator();if(!T.start){T.start=function(U){this.noteOn(U||0)}}else{T.internal_start=T.start;T.start=function(U){T.internal_start(U||0)}}if(!T.stop){T.stop=function(U){this.noteOff(U||0)}}else{T.internal_stop=T.stop;T.stop=function(U){T.internal_stop(U||0)}}if(!T.setPeriodicWave){T.setPeriodicWave=T.setWaveTable}S(T.frequency);S(T.detune);return T}}}if(window.hasOwnProperty("webkitOfflineAudioContext")&&!window.hasOwnProperty("OfflineAudioContext")){window.OfflineAudioContext=webkitOfflineAudioContext}return Q}(window));var N=new window.AudioContext();E.prototype.getAudioContext=function(){return N};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var H=document.createElement("audio");E.prototype.isSupported=function(){return !!H.canPlayType};var J=function(){return !!H.canPlayType&&H.canPlayType('audio/ogg; codecs="vorbis"')};var G=function(){return !!H.canPlayType&&H.canPlayType("audio/mpeg;")};var I=function(){return !!H.canPlayType&&H.canPlayType('audio/wav; codecs="1"')};var O=function(){return !!H.canPlayType&&(H.canPlayType("audio/x-m4a;")||H.canPlayType("audio/aac;"))};var F=function(){return !!H.canPlayType&&H.canPlayType("audio/x-aiff;")};E.prototype.isFileSupported=function(P){switch(P.toLowerCase()){case"mp3":return G();case"wav":return I();case"ogg":return J();case"aac","m4a","mp4":return O();case"aif","aiff":return F();default:return false}};var L=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?true:false;if(L){var M=false;var K=function(){if(M){return}var P=N.createBuffer(1,1,22050);var Q=N.createBufferSource();Q.buffer=P;Q.connect(N.destination);Q.start(0);console.log("start ios!");if(N.state==="running"){M=true}};document.addEventListener("touchend",K,false);document.addEventListener("touchstart",K,false)}}();var n;n=function(){var F=function(){var H=E.prototype.getAudioContext();this.input=H.createGain();this.output=H.createGain();this.limiter=H.createDynamicsCompressor();this.limiter.threshold.value=0;this.limiter.ratio.value=100;this.audiocontext=H;this.output.disconnect();this.inputSources=[];this.input.connect(this.limiter);this.limiter.connect(this.output);this.meter=H.createGain();this.fftMeter=H.createGain();this.output.connect(this.meter);this.output.connect(this.fftMeter);this.output.connect(this.audiocontext.destination);this.soundArray=[];this.parts=[];this.extensions=[]};var G=new F();E.prototype.getMasterVolume=function(){return G.output.gain.value};E.prototype.masterVolume=function(I,L,J){if(typeof I==="number"){var L=L||0;var J=J||0;var H=G.audiocontext.currentTime;var K=G.output.gain.value;G.output.gain.cancelScheduledValues(H+J);G.output.gain.linearRampToValueAtTime(K,H+J);G.output.gain.linearRampToValueAtTime(I,H+J+L)}else{if(I){I.connect(G.output.gain)}else{return G.output.gain}}};E.soundOut=G;E.soundOut._silentNode=G.audiocontext.createGain();E.soundOut._silentNode.gain.value=0;E.soundOut._silentNode.connect(G.audiocontext.destination);return G}(r);var t;t=function(){var F=n;E.prototype.sampleRate=function(){return F.audiocontext.sampleRate};E.prototype.freqToMidi=function(H){var I=Math.log(H/440)/Math.log(2);var G=Math.round(12*I)+57;return G};E.prototype.midiToFreq=function(G){return 440*Math.pow(2,(G-69)/12)};E.prototype.soundFormats=function(){F.extensions=[];for(var G=0;G<arguments.length;G++){arguments[G]=arguments[G].toLowerCase();if(["mp3","wav","ogg","m4a","aac"].indexOf(arguments[G])>-1){F.extensions.push(arguments[G])}else{throw arguments[G]+" is not a valid sound format!"}}};E.prototype.disposeSound=function(){for(var G=0;G<F.soundArray.length;G++){F.soundArray[G].dispose()}};E.prototype.registerMethod("remove",E.prototype.disposeSound);E.prototype._checkFileFormats=function(N){var O;if(typeof N==="string"){O=N;var K=O.split(".").pop();if(["mp3","wav","ogg","m4a","aac"].indexOf(K)>-1){var G=E.prototype.isFileSupported(K);if(G){O=O}else{var I=O.split(".");var L=I[I.length-1];for(var J=0;J<F.extensions.length;J++){var M=F.extensions[J];var G=E.prototype.isFileSupported(M);if(G){L="";if(I.length===2){L+=I[0]}for(var J=1;J<=I.length-2;J++){var H=I[J];L+="."+H}O=L+=".";O=O+=M;break}}}}else{for(var J=0;J<F.extensions.length;J++){var M=F.extensions[J];var G=E.prototype.isFileSupported(M);if(G){O=O+"."+M;break}}}}else{if(typeof N==="object"){for(var J=0;J<N.length;J++){var M=N[J].split(".").pop();var G=E.prototype.isFileSupported(M);if(G){O=N[J];break}}}}return O};E.prototype._mathChain=function(L,J,K,G,I){for(var H in L.mathOps){if(L.mathOps[H] instanceof I){L.mathOps[H].dispose();K=H;if(K<L.mathOps.length-1){G=L.mathOps[H+1]}}}L.mathOps[K-1].disconnect();L.mathOps[K-1].connect(J);J.connect(G);L.mathOps[K]=J;return L}}(n);var x;x=function(){var G=n;var F=G.audiocontext;if(typeof F.createStereoPanner!=="undefined"){E.Panner=function(I,H,J){this.stereoPanner=this.input=F.createStereoPanner();I.connect(this.stereoPanner);this.stereoPanner.connect(H)};E.Panner.prototype.pan=function(K,I){var J=I||0;var H=F.currentTime+J;this.stereoPanner.pan.linearRampToValueAtTime(K,H)};E.Panner.prototype.inputChannels=function(H){};E.Panner.prototype.connect=function(H){this.stereoPanner.connect(H)};E.Panner.prototype.disconnect=function(H){this.stereoPanner.disconnect()}}else{E.Panner=function(I,H,J){this.input=F.createGain();I.connect(this.input);this.left=F.createGain();this.right=F.createGain();this.left.channelInterpretation="discrete";this.right.channelInterpretation="discrete";if(J>1){this.splitter=F.createChannelSplitter(2);this.input.connect(this.splitter);this.splitter.connect(this.left,1);this.splitter.connect(this.right,0)}else{this.input.connect(this.left);this.input.connect(this.right)}this.output=F.createChannelMerger(2);this.left.connect(this.output,0,1);this.right.connect(this.output,0,0);this.output.connect(H)};E.Panner.prototype.pan=function(N,L){var M=L||0;var J=F.currentTime+M;var H=(N+1)/2;var K=Math.cos(H*Math.PI/2);var I=Math.sin(H*Math.PI/2);this.left.gain.linearRampToValueAtTime(I,J);this.right.gain.linearRampToValueAtTime(K,J)};E.Panner.prototype.inputChannels=function(H){if(H===1){this.input.disconnect();this.input.connect(this.left);this.input.connect(this.right)}else{if(H===2){if(typeof(this.splitter==="undefined")){this.splitter=F.createChannelSplitter(2)}this.input.disconnect();this.input.connect(this.splitter);this.splitter.connect(this.left,1);this.splitter.connect(this.right,0)}}};E.Panner.prototype.connect=function(H){this.output.connect(H)};E.Panner.prototype.disconnect=function(H){this.output.disconnect()}}E.Panner3D=function(I,H){var J=F.createPanner();J.panningModel="HRTF";J.distanceModel="linear";J.setPosition(0,0,0);I.connect(J);J.connect(H);J.pan=function(M,L,K){J.setPosition(M,L,K)};return J}}(n);var d;d=function(){var O=n;var P=O.audiocontext;E.SoundFile=function(T,S,Q){if(typeof T!=="undefined"){if(typeof T=="string"||typeof T[0]=="string"){var R=E.prototype._checkFileFormats(T);this.url=R}else{if(typeof T=="object"){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob)){throw"Unable to load file because the File API is not supported"}}}if(T.file){T=T.file}this.file=T}this._looping=false;this._playing=false;this._paused=false;this._pauseTime=0;this._cues=[];this._lastPos=0;this._counterNode;this._scopeNode;this.bufferSourceNodes=[];this.bufferSourceNode=null;this.buffer=null;this.playbackRate=1;this.gain=1;this.input=O.audiocontext.createGain();this.output=O.audiocontext.createGain();this.reversed=false;this.startTime=0;this.endTime=null;this.pauseTime=0;this.mode="sustain";this.startMillis=null;this.amplitude=new E.Amplitude();this.output.connect(this.amplitude.input);this.panPosition=0;this.panner=new E.Panner(this.output,O.input,2);if(this.url||this.file){this.load(S)}O.soundArray.push(this);if(typeof Q==="function"){this.whileLoading=Q}else{this.whileLoading=function(){}}};E.prototype.registerPreloadMethod("loadSound",E.prototype);E.prototype.loadSound=function(S,T,Q){if(window.location.origin.indexOf("file://")>-1&&window.cordova==="undefined"){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}var R=new E.SoundFile(S,T,Q);return R};E.SoundFile.prototype.load=function(U){if(this.url!=undefined&&this.url!=""){var T=this;var S=new XMLHttpRequest();S.addEventListener("progress",function(V){T._updateProgress(V)},false);S.open("GET",this.url,true);S.responseType="arraybuffer";var R=this;S.onload=function(){P.decodeAudioData(S.response,function(V){R.buffer=V;R.panner.inputChannels(V.numberOfChannels);if(U){U(R)}})};S.send()}else{if(this.file!=undefined){var Q=new FileReader();var R=this;Q.onload=function(){P.decodeAudioData(Q.result,function(V){R.buffer=V;R.panner.inputChannels(V.numberOfChannels);if(U){U(R)}})};Q.readAsArrayBuffer(this.file)}}};E.SoundFile.prototype._updateProgress=function(Q){if(Q.lengthComputable){var R=Math.log(Q.loaded/Q.total*9.9);this.whileLoading(R)}else{console.log("size unknown")}};E.SoundFile.prototype.isLoaded=function(){if(this.buffer){return true}else{return false}};E.SoundFile.prototype.play=function(S,V,T,Y,U){var Z=this;var Q=O.audiocontext.currentTime;var W,R;var S=S||0;if(S<0){S=0}S=S+Q;if(this.buffer){this._pauseTime=0;if(this.mode==="restart"&&this.buffer&&this.bufferSourceNode){var Q=O.audiocontext.currentTime;this.bufferSourceNode.stop(S);this._counterNode.stop(S)}this.bufferSourceNode=this._initSourceNode();this._counterNode=this._initCounterNode();if(Y){if(Y>=0&&Y<this.buffer.duration){W=Y}else{throw"start time out of range"}}else{W=0}if(U){U=U<=this.buffer.duration-W?U:this.buffer.duration}else{U=this.buffer.duration-W}var X=T||1;this.bufferSourceNode.connect(this.output);this.output.gain.value=X;V=V||Math.abs(this.playbackRate);this.bufferSourceNode.playbackRate.setValueAtTime(V,Q);if(this._paused){this.bufferSourceNode.start(S,this.pauseTime,U);this._counterNode.start(S,this.pauseTime,U)}else{this.bufferSourceNode.start(S,W,U);this._counterNode.start(S,W,U)}this._playing=true;this._paused=false;this.bufferSourceNodes.push(this.bufferSourceNode);this.bufferSourceNode._arrayIndex=this.bufferSourceNodes.length-1;this.bufferSourceNode.onended=function(aa){var ab=this;this._playing=false;setTimeout(function(){Z.bufferSourceNodes.splice(ab._arrayIndex,1);if(Z.bufferSourceNodes.length===0){Z._playing=false}},1)}}else{throw"not ready to play file, buffer has yet to load. Try preload()"}this.bufferSourceNode.loop=this._looping;this._counterNode.loop=this._looping;if(this._looping===true){var R=W+U;this.bufferSourceNode.loopStart=W;this.bufferSourceNode.loopEnd=R;this._counterNode.loopStart=W;this._counterNode.loopEnd=R}};E.SoundFile.prototype.playMode=function(T){var S=T.toLowerCase();if(S==="restart"&&this.buffer&&this.bufferSourceNode){for(var R=0;R<this.bufferSourceNodes.length-1;R++){var Q=O.audiocontext.currentTime;this.bufferSourceNodes[R].stop(Q)}}if(S==="restart"||S==="sustain"){this.mode=S}else{throw'Invalid play mode. Must be either "restart" or "sustain"'}};E.SoundFile.prototype.pause=function(S){var Q=O.audiocontext.currentTime;var S=S||0;var R=S+Q;if(this.isPlaying()&&this.buffer&&this.bufferSourceNode){this.pauseTime=this.currentTime();this.bufferSourceNode.stop(R);this._counterNode.stop(R);this._paused=true;this._playing=false;this._pauseTime=this.currentTime()}else{this._pauseTime=0}};E.SoundFile.prototype.loop=function(T,S,Q,R,U){this._looping=true;this.play(T,S,Q,R,U)};E.SoundFile.prototype.setLoop=function(Q){if(Q===true){this._looping=true}else{if(Q===false){this._looping=false}else{throw"Error: setLoop accepts either true or false"}}if(this.bufferSourceNode){this.bufferSourceNode.loop=this._looping;this._counterNode.loop=this._looping}};E.SoundFile.prototype.isLooping=function(){if(!this.bufferSourceNode){return false}if(this._looping===true&&this.isPlaying()===true){return true}return false};E.SoundFile.prototype.isPlaying=function(){return this._playing};E.SoundFile.prototype.isPaused=function(){return this._paused};E.SoundFile.prototype.stop=function(R){var T=R||0;if(this.mode=="sustain"){this.stopAll(T);this._playing=false;this.pauseTime=0;this._paused=false}else{if(this.buffer&&this.bufferSourceNode){var Q=O.audiocontext.currentTime;var S=T||0;this.pauseTime=0;this.bufferSourceNode.stop(Q+S);this._counterNode.stop(Q+S);this._playing=false;this._paused=false}}};E.SoundFile.prototype.stopAll=function(S){var Q=O.audiocontext.currentTime;var U=S||0;if(this.buffer&&this.bufferSourceNode){for(var R=0;R<this.bufferSourceNodes.length;R++){if(typeof this.bufferSourceNodes[R]!=undefined){try{this.bufferSourceNodes[R].stop(Q+U)}catch(T){}}}this._counterNode.stop(Q+U)}};E.SoundFile.prototype.setVolume=function(R,U,S){if(typeof R==="number"){var U=U||0;var S=S||0;var Q=O.audiocontext.currentTime;var T=this.output.gain.value;this.output.gain.cancelScheduledValues(Q+S);this.output.gain.linearRampToValueAtTime(T,Q+S);this.output.gain.linearRampToValueAtTime(R,Q+S+U)}else{if(R){R.connect(this.output.gain)}else{return this.output.gain}}};E.SoundFile.prototype.amp=E.SoundFile.prototype.setVolume;E.SoundFile.prototype.fade=E.SoundFile.prototype.setVolume;E.SoundFile.prototype.getVolume=function(){return this.output.gain.value};E.SoundFile.prototype.pan=function(Q,R){this.panPosition=Q;this.panner.pan(Q,R)};E.SoundFile.prototype.getPan=function(){return this.panPosition};E.SoundFile.prototype.rate=function(V){if(this.playbackRate===V&&this.bufferSourceNode){if(this.bufferSourceNode.playbackRate.value===V){return}}this.playbackRate=V;var T=V;if(this.playbackRate===0&&this._playing){this.pause()}if(this.playbackRate<0&&!this.reversed){var U=this.currentTime();var Q=this.bufferSourceNode.playbackRate.value;this.reverseBuffer();T=Math.abs(V);var S=(U-this.duration())/T;this.pauseTime=S}else{if(this.playbackRate>0&&this.reversed){this.reverseBuffer()}}if(this.bufferSourceNode){var R=O.audiocontext.currentTime;this.bufferSourceNode.playbackRate.cancelScheduledValues(R);this.bufferSourceNode.playbackRate.linearRampToValueAtTime(Math.abs(T),R);this._counterNode.playbackRate.cancelScheduledValues(R);this._counterNode.playbackRate.linearRampToValueAtTime(Math.abs(T),R)}};E.SoundFile.prototype.setPitch=function(R){var Q=midiToFreq(R)/midiToFreq(60);this.rate(Q)};E.SoundFile.prototype.getPlaybackRate=function(){return this.playbackRate};E.SoundFile.prototype.duration=function(){if(this.buffer){return this.buffer.duration}else{return 0}};E.SoundFile.prototype.currentTime=function(){if(this._pauseTime>0){return this._pauseTime}else{return this._lastPos/P.sampleRate}};E.SoundFile.prototype.jump=function(S,T){if(S<0||S>this.buffer.duration){throw"jump time out of range"}if(T>this.buffer.duration-S){throw"end time out of range"}var Q=S||0;var R=T||this.buffer.duration-S;if(this.isPlaying()){this.stop()}this.play(0,this.playbackRate,this.output.gain.value,Q,R)};E.SoundFile.prototype.channels=function(){return this.buffer.numberOfChannels};E.SoundFile.prototype.sampleRate=function(){return this.buffer.sampleRate};E.SoundFile.prototype.frames=function(){return this.buffer.length};E.SoundFile.prototype.getPeaks=function(R){if(this.buffer){if(!R){R=window.width*5}if(this.buffer){var W=this.buffer;var S=W.length/R;var Y=~~(S/10)||1;var Z=W.numberOfChannels;var ac=new Float32Array(Math.round(R));for(var aa=0;aa<Z;aa++){var T=W.getChannelData(aa);for(var X=0;X<R;X++){var Q=~~(X*S);var U=~~(Q+S);var ab=0;for(var V=Q;V<U;V+=Y){var ad=T[V];if(ad>ab){ab=ad}else{if(-ad>ab){ab=ad}}}if(aa===0||Math.abs(ab)>ac[X]){ac[X]=ab}}}return ac}}else{throw"Cannot load peaks yet, buffer is not loaded"}};E.SoundFile.prototype.reverseBuffer=function(){var R=this.getVolume();this.setVolume(0,0.01,0);this.pause();if(this.buffer){for(var Q=0;Q<this.buffer.numberOfChannels;Q++){Array.prototype.reverse.call(this.buffer.getChannelData(Q))}this.reversed=!this.reversed}else{throw"SoundFile is not done loading"}this.setVolume(R,0.01,0.0101);this.play()};E.SoundFile.prototype._onEnded=function(Q){Q.onended=function(S){var R=O.audiocontext.currentTime;S.stop(R)}};E.SoundFile.prototype.add=function(){};E.SoundFile.prototype.dispose=function(){var Q=O.audiocontext.currentTime;this.stop(Q);if(this.buffer&&this.bufferSourceNode){for(var R=0;R<this.bufferSourceNodes.length-1;R++){if(this.bufferSourceNodes[R]!==null){this.bufferSourceNodes[R].disconnect();try{this.bufferSourceNodes[R].stop(Q)}catch(S){}this.bufferSourceNodes[R]=null}}if(this.isPlaying()){try{this._counterNode.stop(Q)}catch(S){console.log(S)}this._counterNode=null}}if(this.output){this.output.disconnect();this.output=null}if(this.panner){this.panner.disconnect();this.panner=null}};E.SoundFile.prototype.connect=function(Q){if(!Q){this.panner.connect(O.input)}else{if(Q.hasOwnProperty("input")){this.panner.connect(Q.input)}else{this.panner.connect(Q)}}};E.SoundFile.prototype.disconnect=function(Q){this.panner.disconnect(Q)};E.SoundFile.prototype.getLevel=function(Q){if(Q){this.amplitude.smoothing=Q}return this.amplitude.getLevel()};E.SoundFile.prototype.setPath=function(R,S){var Q=E.prototype._checkFileFormats(R);this.url=Q;this.load(S)};E.SoundFile.prototype.setBuffer=function(R){var T=R.length;var S=R[0].length;var Q=P.createBuffer(T,S,P.sampleRate);if(!R[0] instanceof Float32Array){R[0]=new Float32Array(R[0])}for(var V=0;V<T;V++){var U=Q.getChannelData(V);U.set(R[V])}this.buffer=Q;this.panner.inputChannels(T)};E.SoundFile.prototype._initCounterNode=function(){var Q=this;var S=P.currentTime;var R=P.createBufferSource();if(Q._scopeNode){Q._scopeNode.disconnect();Q._scopeNode=null}Q._scopeNode=P.createScriptProcessor(256,1,1);R.buffer=J(Q.buffer);R.playbackRate.setValueAtTime(Q.playbackRate,S);R.connect(Q._scopeNode);Q._scopeNode.connect(E.soundOut._silentNode);Q._scopeNode.onaudioprocess=function(T){var U=T.inputBuffer.getChannelData(0);Q._lastPos=U[U.length-1]||0;Q._onTimeUpdate(Q._lastPos)};return R};E.SoundFile.prototype._initSourceNode=function(){var Q=this;var R=P.currentTime;var S=P.createBufferSource();S.buffer=Q.buffer;S.playbackRate.setValueAtTime(Q.playbackRate,R);return S};var J=function(Q){var T=new Float32Array(Q.length);var S=P.createBuffer(1,Q.length,44100);for(var R=0;R<Q.length;R++){T[R]=R}S.getChannelData(0).set(T);return S};E.SoundFile.prototype.processPeaks=function(ac,R,Z,aa){var ad=this.buffer.length;var ab=this.buffer.sampleRate;var U=this.buffer;var T=R||0.9,V=T,X=Z||0.22,Y=aa||200;var W=new OfflineAudioContext(1,ad,ab);var Q=W.createBufferSource();Q.buffer=U;var S=W.createBiquadFilter();S.type="lowpass";Q.connect(S);S.connect(W.destination);Q.start(0);W.startRendering();W.oncomplete=function(aj){var ai={};var am=aj.renderedBuffer;var ak=am.getChannelData(0);do{M=G(ak,V);V-=0.005}while(Object.keys(M).length<Y&&V>=X);var al=F(M);var ag=I(al,am.sampleRate);var af=ag.sort(function(ao,an){return an.count-ao.count}).splice(0,5);this.tempo=af[0].tempo;var ah=5;var ae=N(M,af[0].tempo,am.sampleRate,ah);ac(ae)}};var K=function(Q,R){this.sampleIndex=R;this.amplitude=Q;this.tempos=[];this.intervals=[]};var M=[];function G(V,Q){var W={};var U=V.length;for(var S=0;S<U;S++){if(V[S]>Q){var R=V[S];var T=new K(R,S);W[S]=T;S+=6000}S++}return W}function F(V){var Z=[];var Q=Object.keys(V).sort();for(var W=0;W<Q.length;W++){for(var U=0;U<10;U++){var T=V[Q[W]];var Y=V[Q[W+U]];if(T&&Y){var X=T.sampleIndex;var R=Y.sampleIndex;var S=R-X;if(S>0){T.intervals.push(S)}var aa=Z.some(function(ab,ac){if(ab.interval===S){ab.count++;return ab}});if(!aa){Z.push({interval:S,count:1})}}}}return Z}function I(R,Q){var S=[];R.forEach(function(U,V){try{var T=Math.abs(60/(U.interval/Q));T=L(T);var X=S.some(function(Y){if(Y.tempo===T){return Y.count+=U.count}});if(!X){if(isNaN(T)){return}S.push({tempo:Math.round(T),count:U.count})}}catch(W){throw W}});return S}function N(W,X,Z,S){var ab=[];var Q=Object.keys(W).sort();for(var U=0;U<Q.length;U++){var aa=Q[U];var R=W[aa];for(var T=0;T<R.intervals.length;T++){var V=Math.round(Math.abs(60/(R.intervals[T]/Z)));V=L(V);var Y=V-X;if(Math.abs(V-X)<S){ab.push(R.sampleIndex/44100)}}}ab=ab.filter(function(ad,ae,ac){var af=ac[ae+1]-ad;if(af>0.01){return true}});return ab}function L(Q){if(!isFinite(Q)||Q==0){return}while(Q<90){Q*=2}while(Q>180&&Q>90){Q/=2}return Q}E.SoundFile.prototype.addCue=function(R,U,S){var T=this._cueIDCounter++;var Q=new H(U,R,T,S);this._cues.push(Q);return T};E.SoundFile.prototype.removeCue=function(S){for(var R=0;R<this._cues.length;R++){var Q=this._cues[R];if(Q.id===S){this.cues.splice(R,1)}}if(this._cues.length===0){}};E.SoundFile.prototype.clearCues=function(){this._cues=[]};E.SoundFile.prototype._onTimeUpdate=function(Q){var U=Q/this.buffer.sampleRate;for(var S=0;S<this._cues.length;S++){var R=this._cues[S].time;var T=this._cues[S].val;if(this._prevTime<R&&R<=U){this._cues[S].callback(T)}}this._prevTime=U};var H=function(T,Q,S,R){this.callback=T;this.time=Q;this.id=S;this.val=R}}(r,n);var i;i=function(){var F=n;E.Amplitude=function(G){this.bufferSize=2048;this.audiocontext=F.audiocontext;this.processor=this.audiocontext.createScriptProcessor(this.bufferSize,2,1);this.input=this.processor;this.output=this.audiocontext.createGain();this.smoothing=G||0;this.volume=0;this.average=0;this.stereoVol=[0,0];this.stereoAvg=[0,0];this.stereoVolNorm=[0,0];this.volMax=0.001;this.normalize=false;this.processor.onaudioprocess=this._audioProcess.bind(this);this.processor.connect(this.output);this.output.gain.value=0;this.output.connect(this.audiocontext.destination);F.meter.connect(this.processor)};E.Amplitude.prototype.setInput=function(H,G){F.meter.disconnect();if(G){this.smoothing=G}if(H==null){console.log("Amplitude input source is not ready! Connecting to master output instead");F.meter.connect(this.processor)}else{if(H instanceof E.Signal){H.output.connect(this.processor)}else{if(H){H.connect(this.processor);this.processor.disconnect();this.processor.connect(this.output)}else{F.meter.connect(this.processor)}}}};E.Amplitude.prototype.connect=function(G){if(G){if(G.hasOwnProperty("input")){this.output.connect(G.input)}else{this.output.connect(G)}}else{this.output.connect(this.panner.connect(F.input))}};E.Amplitude.prototype.disconnect=function(G){this.output.disconnect()};E.Amplitude.prototype._audioProcess=function(G){for(var L=0;L<G.inputBuffer.numberOfChannels;L++){var J=G.inputBuffer.getChannelData(L);var R=J.length;var M=0;var K=0;var N;for(var I=0;I<R;I++){N=J[I];if(this.normalize){M+=Math.max(Math.min(N/this.volMax,1),-1);K+=Math.max(Math.min(N/this.volMax,1),-1)*Math.max(Math.min(N/this.volMax,1),-1)}else{M+=N;K+=N*N}}var H=M/R;var O=Math.sqrt(K/R);this.stereoVol[L]=Math.max(O,this.stereoVol[L]*this.smoothing);this.stereoAvg[L]=Math.max(H,this.stereoVol[L]*this.smoothing);this.volMax=Math.max(this.stereoVol[L],this.volMax)}var Q=this;var P=this.stereoVol.reduce(function(S,U,T){Q.stereoVolNorm[T-1]=Math.max(Math.min(Q.stereoVol[T-1]/Q.volMax,1),0);Q.stereoVolNorm[T]=Math.max(Math.min(Q.stereoVol[T]/Q.volMax,1),0);return S+U});this.volume=P/this.stereoVol.length;this.volNorm=Math.max(Math.min(this.volume/this.volMax,1),0)};E.Amplitude.prototype.getLevel=function(G){if(typeof G!=="undefined"){if(this.normalize){return this.stereoVolNorm[G]}else{return this.stereoVol[G]}}else{if(this.normalize){return this.volNorm}else{return this.volume}}};E.Amplitude.prototype.toggleNormalize=function(G){if(typeof G==="boolean"){this.normalize=G}else{this.normalize=!this.normalize}};E.Amplitude.prototype.smooth=function(G){if(G>=0&&G<1){this.smoothing=G}else{console.log("Error: smoothing must be between 0 and 1")}}}(n);var s;s=function(){var I=n;E.FFT=function(K,L){this.smoothing=K||0.8;this.bins=L||1024;var M=L*2||2048;this.input=this.analyser=I.audiocontext.createAnalyser();I.fftMeter.connect(this.analyser);this.analyser.smoothingTimeConstant=this.smoothing;this.analyser.fftSize=M;this.freqDomain=new Uint8Array(this.analyser.frequencyBinCount);this.timeDomain=new Uint8Array(this.analyser.frequencyBinCount);this.bass=[20,140];this.lowMid=[140,400];this.mid=[400,2600];this.highMid=[2600,5200];this.treble=[5200,14000]};E.FFT.prototype.setInput=function(K){if(!K){I.fftMeter.connect(this.analyser)}else{if(K.output){K.output.connect(this.analyser)}else{if(K.connect){K.connect(this.analyser)}}I.fftMeter.disconnect()}};E.FFT.prototype.waveform=function(){var N,O,M;for(var L=0;L<arguments.length;L++){if(typeof arguments[L]==="number"){N=arguments[L];this.analyser.fftSize=N*2}if(typeof arguments[L]==="string"){O=arguments[L]}}if(O&&!E.prototype._isSafari()){H(this,this.timeDomain);this.analyser.getFloatTimeDomainData(this.timeDomain);return this.timeDomain}else{G(this,this.timeDomain);this.analyser.getByteTimeDomainData(this.timeDomain);var M=new Array();for(var L=0;L<this.timeDomain.length;L++){var K=E.prototype.map(this.timeDomain[L],0,255,-1,1);M.push(K)}return M}};E.FFT.prototype.analyze=function(){var M,N;for(var L=0;L<arguments.length;L++){if(typeof arguments[L]==="number"){M=this.bins=arguments[L];this.analyser.fftSize=this.bins*2}if(typeof arguments[L]==="string"){N=arguments[L]}}if(N&&N.toLowerCase()==="db"){F(this);this.analyser.getFloatFrequencyData(this.freqDomain);return this.freqDomain}else{J(this,this.freqDomain);this.analyser.getByteFrequencyData(this.freqDomain);var K=Array.apply([],this.freqDomain);K.length===this.analyser.fftSize;K.constructor===Array;return K}};E.FFT.prototype.getEnergy=function(U,T){var M=I.audiocontext.sampleRate/2;if(U==="bass"){U=this.bass[0];T=this.bass[1]}else{if(U==="lowMid"){U=this.lowMid[0];T=this.lowMid[1]}else{if(U==="mid"){U=this.mid[0];T=this.mid[1]}else{if(U==="highMid"){U=this.highMid[0];T=this.highMid[1]}else{if(U==="treble"){U=this.treble[0];T=this.treble[1]}}}}}if(typeof U!=="number"){throw"invalid input for getEnergy()"}else{if(!T){var Q=Math.round(U/M*this.freqDomain.length);return this.freqDomain[Q]}else{if(U&&T){if(U>T){var L=T;T=U;U=L}var S=Math.round(U/M*this.freqDomain.length);var K=Math.round(T/M*this.freqDomain.length);var R=0;var N=0;for(var O=S;O<=K;O++){R+=this.freqDomain[O];N+=1}var P=R/N;return P}else{throw"invalid input for getEnergy()"}}}};E.FFT.prototype.getFreq=function(M,L){console.log("getFreq() is deprecated. Please use getEnergy() instead.");var K=this.getEnergy(M,L);return K};E.FFT.prototype.smooth=function(K){if(K){this.smoothing=K}this.analyser.smoothingTimeConstant=K};var F=function(K){if(K.freqDomain instanceof Float32Array===false){K.freqDomain=new Float32Array(K.analyser.frequencyBinCount)}};var J=function(K){if(K.freqDomain instanceof Uint8Array===false){K.freqDomain=new Uint8Array(K.analyser.frequencyBinCount)}};var H=function(K){if(K.timeDomain instanceof Float32Array===false){K.timeDomain=new Float32Array(K.analyser.frequencyBinCount)}};var G=function(K){if(K.timeDomain instanceof Uint8Array===false){K.timeDomain=new Uint8Array(K.analyser.frequencyBinCount)}}}(n);var D;D=function(){function H(K){return K===void 0}var J;if(H(window.AudioContext)){window.AudioContext=window.webkitAudioContext}if(H(window.OfflineAudioContext)){window.OfflineAudioContext=window.webkitOfflineAudioContext}if(!H(AudioContext)){J=new AudioContext()}else{throw new Error("Web Audio is not supported in this browser")}if(typeof AudioContext.prototype.createGain!=="function"){AudioContext.prototype.createGain=AudioContext.prototype.createGainNode}if(typeof AudioContext.prototype.createDelay!=="function"){AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode}if(typeof AudioContext.prototype.createPeriodicWave!=="function"){AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable}if(typeof AudioBufferSourceNode.prototype.start!=="function"){AudioBufferSourceNode.prototype.start=AudioBufferSourceNode.prototype.noteGrainOn}if(typeof AudioBufferSourceNode.prototype.stop!=="function"){AudioBufferSourceNode.prototype.stop=AudioBufferSourceNode.prototype.noteOff}if(typeof OscillatorNode.prototype.start!=="function"){OscillatorNode.prototype.start=OscillatorNode.prototype.noteOn}if(typeof OscillatorNode.prototype.stop!=="function"){OscillatorNode.prototype.stop=OscillatorNode.prototype.noteOff}if(typeof OscillatorNode.prototype.setPeriodicWave!=="function"){OscillatorNode.prototype.setPeriodicWave=OscillatorNode.prototype.setWaveTable}if(!window.Tone){AudioNode.prototype._nativeConnect=AudioNode.prototype.connect;AudioNode.prototype.connect=function(N,L,K){if(N.input){if(Array.isArray(N.input)){if(H(K)){K=0}this.connect(N.input[K])}else{this.connect(N.input,L,K)}}else{try{if(N instanceof AudioNode){this._nativeConnect(N,L,K)}else{this._nativeConnect(N,L)}}catch(M){throw new Error("error connecting to node: "+N)}}}}var G=function(K,L){if(H(K)||K===1){this.input=this.context.createGain()}else{if(K>1){this.input=new Array(K)}}if(H(L)||L===1){this.output=this.context.createGain()}else{if(L>1){this.output=new Array(K)}}};G.context=J;G.prototype.context=G.context;G.prototype.bufferSize=2048;G.prototype.bufferTime=G.prototype.bufferSize/G.context.sampleRate;G.prototype.connect=function(L,K,M){if(Array.isArray(this.output)){K=this.defaultArg(K,0);this.output[K].connect(L,0,M)}else{this.output.connect(L,K,M)}};G.prototype.disconnect=function(K){if(Array.isArray(this.output)){K=this.defaultArg(K,0);this.output[K].disconnect()}else{this.output.disconnect()}};G.prototype.connectSeries=function(){if(arguments.length>1){var L=arguments[0];for(var K=1;K<arguments.length;K++){var M=arguments[K];L.connect(M);L=M}}};G.prototype.connectParallel=function(){var M=arguments[0];if(arguments.length>1){for(var K=1;K<arguments.length;K++){var L=arguments[K];M.connect(L)}}};G.prototype.chain=function(){if(arguments.length>0){var L=this;for(var K=0;K<arguments.length;K++){var M=arguments[K];L.connect(M);L=M}}};G.prototype.fan=function(){if(arguments.length>0){for(var K=1;K<arguments.length;K++){this.connect(arguments[K])}}};AudioNode.prototype.chain=G.prototype.chain;AudioNode.prototype.fan=G.prototype.fan;G.prototype.defaultArg=function(O,N){if(typeof O==="object"&&typeof N==="object"){var K={};for(var M in O){K[M]=this.defaultArg(O[M],O[M])}for(var L in N){K[L]=this.defaultArg(O[L],N[L])}return K}else{return H(O)?N:O}};G.prototype.optionsObject=function(K,N,O){var L={};if(K.length===1&&typeof K[0]==="object"){L=K[0]}else{for(var M=0;M<N.length;M++){L[N[M]]=K[M]}}if(!this.isUndef(O)){return this.defaultArg(L,O)}else{return L}};G.prototype.isUndef=H;G.prototype.equalPowerScale=function(L){var K=0.5*Math.PI;return Math.sin(L*K)};G.prototype.logScale=function(K){return Math.max(this.normalize(this.gainToDb(K),-100,0),0)};G.prototype.expScale=function(K){return this.dbToGain(this.interpolate(K,-100,0))};G.prototype.dbToGain=function(K){return Math.pow(2,K/6)};G.prototype.gainToDb=function(K){return 20*(Math.log(K)/Math.LN10)};G.prototype.interpolate=function(L,K,M){return L*(M-K)+K};G.prototype.normalize=function(K,N,M){if(N>M){var L=M;M=N;N=L}else{if(N==M){return 0}}return(K-N)/(M-N)};G.prototype.dispose=function(){if(!this.isUndef(this.input)){if(this.input instanceof AudioNode){this.input.disconnect()}this.input=null}if(!this.isUndef(this.output)){if(this.output instanceof AudioNode){this.output.disconnect()}this.output=null}};var I=null;G.prototype.noGC=function(){this.output.connect(I)};AudioNode.prototype.noGC=function(){this.connect(I)};G.prototype.now=function(){return this.context.currentTime};G.prototype.samplesToSeconds=function(K){return K/this.context.sampleRate};G.prototype.toSamples=function(K){var L=this.toSeconds(K);return Math.round(L*this.context.sampleRate)};G.prototype.toSeconds=function(M,K){K=this.defaultArg(K,this.now());if(typeof M==="number"){return M}else{if(typeof M==="string"){var L=0;if(M.charAt(0)==="+"){M=M.slice(1);L=K}return parseFloat(M)+L}else{return K}}};G.prototype.frequencyToSeconds=function(K){return 1/parseFloat(K)};G.prototype.secondsToFrequency=function(K){return 1/K};var F=[];G._initAudioContext=function(K){K(G.context);F.push(K)};G.setContext=function(K){G.prototype.context=K;G.context=K;for(var L=0;L<F.length;L++){F[L](K)}};G.extend=function(M,K){if(H(K)){K=G}function L(){}L.prototype=K.prototype;M.prototype=new L();M.prototype.constructor=M};G.startMobile=function(){var M=G.context.createOscillator();var K=G.context.createGain();K.gain.value=0;M.connect(K);K.connect(G.context.destination);var L=G.context.currentTime;M.start(L);M.stop(L+1)};G._initAudioContext(function(K){G.prototype.bufferTime=G.prototype.bufferSize/K.sampleRate;I=K.createGain();I.gain.value=0;I.connect(K.destination)});return G}();var j;j=function(F){F.SignalBase=function(){};F.extend(F.SignalBase);F.SignalBase.prototype.connect=function(H,I,G){if(H instanceof F.Signal){H.setValue(0)}else{if(H instanceof AudioParam){H.value=0}}F.prototype.connect.call(this,H,I,G)};F.SignalBase.prototype.dispose=function(){F.prototype.dispose.call(this)};return F.SignalBase}(D);var w;w=function(F){F.WaveShaper=function(G,H){this._shaper=this.input=this.output=this.context.createWaveShaper();this._curve=null;if(Array.isArray(G)){this.setCurve(G)}else{if(isFinite(G)||this.isUndef(G)){this._curve=new Float32Array(this.defaultArg(G,1024))}else{if(typeof G==="function"){this._curve=new Float32Array(this.defaultArg(H,1024));this.setMap(G)}}}};F.extend(F.WaveShaper,F.SignalBase);F.WaveShaper.prototype.setMap=function(I){for(var J=0,G=this._curve.length;J<G;J++){var K=J/G*2-1;var H=J/(G-1)*2-1;this._curve[J]=I(K,J,H)}this._shaper.curve=this._curve};F.WaveShaper.prototype.setCurve=function(G){if(this._isSafari()){var H=G[0];G.unshift(H)}this._curve=new Float32Array(G);this._shaper.curve=this._curve};F.WaveShaper.prototype.setOversample=function(G){this._shaper.oversample=G};F.WaveShaper.prototype._isSafari=function(){var G=navigator.userAgent.toLowerCase();return G.indexOf("safari")!==-1&&G.indexOf("chrome")===-1};F.WaveShaper.prototype.dispose=function(){F.prototype.dispose.call(this);this._shaper.disconnect();this._shaper=null;this._curve=null};return F.WaveShaper}(D);var l;l=function(F){F.Signal=function(G){this._scalar=this.context.createGain();this.input=this.output=this.context.createGain();this._syncRatio=1;this.value=this.defaultArg(G,0);F.Signal._constant.chain(this._scalar,this.output)};F.extend(F.Signal,F.SignalBase);F.Signal.prototype.getValue=function(){return this._scalar.gain.value};F.Signal.prototype.setValue=function(G){if(this._syncRatio===0){G=0}else{G*=this._syncRatio}this._scalar.gain.value=G};F.Signal.prototype.setValueAtTime=function(G,H){G*=this._syncRatio;this._scalar.gain.setValueAtTime(G,this.toSeconds(H))};F.Signal.prototype.setCurrentValueNow=function(H){H=this.defaultArg(H,this.now());var G=this.getValue();this.cancelScheduledValues(H);this._scalar.gain.setValueAtTime(G,H);return G};F.Signal.prototype.linearRampToValueAtTime=function(H,G){H*=this._syncRatio;this._scalar.gain.linearRampToValueAtTime(H,this.toSeconds(G))};F.Signal.prototype.exponentialRampToValueAtTime=function(H,G){H*=this._syncRatio;try{this._scalar.gain.exponentialRampToValueAtTime(H,this.toSeconds(G))}catch(I){this._scalar.gain.linearRampToValueAtTime(H,this.toSeconds(G))}};F.Signal.prototype.exponentialRampToValueNow=function(I,G){var H=this.now();this.setCurrentValueNow(H);if(G.toString().charAt(0)==="+"){G=G.substr(1)}this.exponentialRampToValueAtTime(I,H+this.toSeconds(G))};F.Signal.prototype.linearRampToValueNow=function(I,G){var H=this.now();this.setCurrentValueNow(H);I*=this._syncRatio;if(G.toString().charAt(0)==="+"){G=G.substr(1)}this._scalar.gain.linearRampToValueAtTime(I,H+this.toSeconds(G))};F.Signal.prototype.setTargetAtTime=function(I,G,H){I*=this._syncRatio;this._scalar.gain.setTargetAtTime(I,this.toSeconds(G),H)};F.Signal.prototype.setValueCurveAtTime=function(G,I,J){for(var H=0;H<G.length;H++){G[H]*=this._syncRatio}this._scalar.gain.setValueCurveAtTime(G,this.toSeconds(I),this.toSeconds(J))};F.Signal.prototype.cancelScheduledValues=function(G){this._scalar.gain.cancelScheduledValues(this.toSeconds(G))};F.Signal.prototype.sync=function(H,G){if(G){this._syncRatio=G}else{if(H.getValue()!==0){this._syncRatio=this.getValue()/H.getValue()}else{this._syncRatio=0}}this._scalar.disconnect();this._scalar=this.context.createGain();this.connectSeries(H,this._scalar,this.output);this._scalar.gain.value=this._syncRatio};F.Signal.prototype.unsync=function(){var G=this.getValue();this._scalar.disconnect();this._scalar=this.context.createGain();this._scalar.gain.value=G/this._syncRatio;this._syncRatio=1;F.Signal._constant.chain(this._scalar,this.output)};F.Signal.prototype.dispose=function(){F.prototype.dispose.call(this);this._scalar.disconnect();this._scalar=null};Object.defineProperty(F.Signal.prototype,"value",{get:function(){return this.getValue()},set:function(G){this.setValue(G)}});F.Signal._generator=null;F.Signal._constant=null;F._initAudioContext(function(G){F.Signal._generator=G.createOscillator();F.Signal._constant=new F.WaveShaper([1,1]);F.Signal._generator.connect(F.Signal._constant);F.Signal._generator.start(0);F.Signal._generator.noGC()});return F.Signal}(D);var g;g=function(F){F.Add=function(G){F.call(this,2,0);this._sum=this.input[0]=this.input[1]=this.output=this.context.createGain();this._value=null;if(isFinite(G)){this._value=new F.Signal(G);this._value.connect(this._sum)}};F.extend(F.Add,F.SignalBase);F.Add.prototype.setValue=function(G){if(this._value!==null){this._value.setValue(G)}else{throw new Error("cannot switch from signal to number")}};F.Add.prototype.dispose=function(){F.prototype.dispose.call(this);this._sum=null;if(this._value){this._value.dispose();this._value=null}};return F.Add}(D);var c;c=function(F){F.Multiply=function(G){F.call(this,2,0);this._mult=this.input[0]=this.output=this.context.createGain();this._factor=this.input[1]=this.output.gain;this._factor.value=this.defaultArg(G,0)};F.extend(F.Multiply,F.SignalBase);F.Multiply.prototype.setValue=function(G){this._factor.value=G};F.Multiply.prototype.dispose=function(){F.prototype.dispose.call(this);this._mult=null;this._factor=null};return F.Multiply}(D);var h;h=function(F){F.Scale=function(G,H){this._outputMin=this.defaultArg(G,0);this._outputMax=this.defaultArg(H,1);this._scale=this.input=new F.Multiply(1);this._add=this.output=new F.Add(0);this._scale.connect(this._add);this._setRange()};F.extend(F.Scale,F.SignalBase);F.Scale.prototype.setMin=function(G){this._outputMin=G;this._setRange()};F.Scale.prototype.setMax=function(G){this._outputMax=G;this._setRange()};F.Scale.prototype._setRange=function(){this._add.setValue(this._outputMin);this._scale.setValue(this._outputMax-this._outputMin)};F.Scale.prototype.dispose=function(){F.prototype.dispose.call(this);this._add.dispose();this._add=null;this._scale.dispose();this._scale=null};return F.Scale}(D,g,c);var A;A=function(){var J=l;var G=g;var I=c;var F=h;var H=D;var K=n;H.setContext(K.audiocontext);E.Signal=function(M){var L=new J(M);return L};J.prototype.fade=J.prototype.linearRampToValueAtTime;I.prototype.fade=J.prototype.fade;G.prototype.fade=J.prototype.fade;F.prototype.fade=J.prototype.fade;J.prototype.setInput=function(L){L.connect(this)};I.prototype.setInput=J.prototype.setInput;G.prototype.setInput=J.prototype.setInput;F.prototype.setInput=J.prototype.setInput;J.prototype.add=function(L){var M=new G(L);this.connect(M);return M};I.prototype.add=J.prototype.add;G.prototype.add=J.prototype.add;F.prototype.add=J.prototype.add;J.prototype.mult=function(L){var M=new I(L);this.connect(M);return M};I.prototype.mult=J.prototype.mult;G.prototype.mult=J.prototype.mult;F.prototype.mult=J.prototype.mult;J.prototype.scale=function(M,R,L,Q){var P,N;if(arguments.length===4){P=E.prototype.map(L,M,R,0,1)-0.5;N=E.prototype.map(Q,M,R,0,1)-0.5}else{P=arguments[0];N=arguments[1]}var O=new F(P,N);this.connect(O);return O};I.prototype.scale=J.prototype.scale;G.prototype.scale=J.prototype.scale;F.prototype.scale=J.prototype.scale}(l,g,c,h,D,n);var v;v=function(){var K=n;var I=l;var G=g;var H=c;var F=h;E.Oscillator=function(N,L){if(typeof N==="string"){var M=L;L=N;N=M}if(typeof L==="number"){var M=L;L=N;N=M}this.started=false;this.oscillator=K.audiocontext.createOscillator();this.f=N||440;this.oscillator.frequency.setValueAtTime(this.f,K.audiocontext.currentTime);this.oscillator.type=L||"sine";var O=this.oscillator;this.input=K.audiocontext.createGain();this.output=K.audiocontext.createGain();this._freqMods=[];this.output.gain.value=0.5;this.output.gain.setValueAtTime(0.5,K.audiocontext.currentTime);this.oscillator.connect(this.output);this.panPosition=0;this.connection=K.input;this.panner=new E.Panner(this.output,this.connection,1);this.mathOps=[this.output];K.soundArray.push(this)};E.Oscillator.prototype.start=function(Q,O){if(this.started){var L=K.audiocontext.currentTime;this.stop(L)}if(!this.started){var P=O||this.f;var N=this.oscillator.type;this.oscillator=K.audiocontext.createOscillator();this.oscillator.frequency.exponentialRampToValueAtTime(Math.abs(P),K.audiocontext.currentTime);this.oscillator.type=N;this.oscillator.connect(this.output);Q=Q||0;this.oscillator.start(Q+K.audiocontext.currentTime);this.freqNode=this.oscillator.frequency;for(var M in this._freqMods){if(typeof this._freqMods[M].connect!=="undefined"){this._freqMods[M].connect(this.oscillator.frequency)}}this.started=true}};E.Oscillator.prototype.stop=function(N){if(this.started){var M=N||0;var L=K.audiocontext.currentTime;this.oscillator.stop(M+L);this.started=false}};E.Oscillator.prototype.amp=function(N,Q,O){var L=this;if(typeof N==="number"){var Q=Q||0;var O=O||0;var M=K.audiocontext.currentTime;var P=this.output.gain.value;this.output.gain.cancelScheduledValues(M);this.output.gain.linearRampToValueAtTime(P,M+O);this.output.gain.linearRampToValueAtTime(N,M+O+Q)}else{if(N){console.log(N);N.connect(L.output.gain)}else{return this.output.gain}}};E.Oscillator.prototype.fade=E.Oscillator.prototype.amp;E.Oscillator.prototype.getAmp=function(){return this.output.gain.value};E.Oscillator.prototype.freq=function(O,P,N){if(typeof O==="number"&&!isNaN(O)){this.f=O;var L=K.audiocontext.currentTime;var P=P||0;var N=N||0;var M=this.oscillator.frequency.value;this.oscillator.frequency.cancelScheduledValues(L);this.oscillator.frequency.setValueAtTime(M,L+N);if(O>0){this.oscillator.frequency.exponentialRampToValueAtTime(O,N+P+L)}else{this.oscillator.frequency.linearRampToValueAtTime(O,N+P+L)}}else{if(O){if(O.output){O=O.output}O.connect(this.oscillator.frequency);this._freqMods.push(O)}else{return this.oscillator.frequency}}};E.Oscillator.prototype.getFreq=function(){return this.oscillator.frequency.value};E.Oscillator.prototype.setType=function(L){this.oscillator.type=L};E.Oscillator.prototype.getType=function(){return this.oscillator.type};E.Oscillator.prototype.connect=function(L){if(!L){this.panner.connect(K.input)}else{if(L.hasOwnProperty("input")){this.panner.connect(L.input);this.connection=L.input}else{this.panner.connect(L);this.connection=L}}};E.Oscillator.prototype.disconnect=function(L){this.output.disconnect();this.panner.disconnect();this.output.connect(this.panner);this.oscMods=[]};E.Oscillator.prototype.pan=function(L,M){this.panPosition=L;this.panner.pan(L,M)};E.Oscillator.prototype.getPan=function(){return this.panPosition};E.Oscillator.prototype.dispose=function(){if(this.oscillator){var L=K.audiocontext.currentTime;this.stop(L);this.disconnect();this.oscillator.disconnect();this.panner=null;this.oscillator=null}if(this.osc2){this.osc2.dispose()}};E.Oscillator.prototype.phase=function(M){if(!this.dNode){this.dNode=K.audiocontext.createDelay();this.output.disconnect();this.output.connect(this.dNode);this.dNode.connect(this.panner)}var L=K.audiocontext.currentTime;this.dNode.delayTime.linearRampToValueAtTime(E.prototype.map(M,0,1,0,1/this.oscillator.frequency.value),L)};var J=function(R,O,Q,L,N){var P=R.oscillator;for(var M in R.mathOps){if(R.mathOps[M] instanceof N){P.disconnect();R.mathOps[M].dispose();Q=M;if(Q<R.mathOps.length-2){L=R.mathOps[M+1]}}}if(Q==R.mathOps.length-1){R.mathOps.push(L)}if(M>0){P=R.mathOps[M-1]}P.disconnect();P.connect(O);O.connect(L);R.mathOps[Q]=O;return R};E.Oscillator.prototype.add=function(M){var N=new G(M);var O=this.mathOps.length-1;var L=this.output;return J(this,N,O,L,G)};E.Oscillator.prototype.mult=function(M){var N=new H(M);var O=this.mathOps.length-1;var L=this.output;return J(this,N,O,L,H)};E.Oscillator.prototype.scale=function(Q,T,L,O){var R,M;if(arguments.length===4){R=E.prototype.map(L,Q,T,0,1)-0.5;M=E.prototype.map(O,Q,T,0,1)-0.5}else{R=arguments[0];M=arguments[1]}var N=new F(R,M);var P=this.mathOps.length-1;var S=this.output;return J(this,N,P,S,F)};E.SinOsc=function(L){E.Oscillator.call(this,L,"sine")};E.SinOsc.prototype=Object.create(E.Oscillator.prototype);E.TriOsc=function(L){E.Oscillator.call(this,L,"triangle")};E.TriOsc.prototype=Object.create(E.Oscillator.prototype);E.SawOsc=function(L){E.Oscillator.call(this,L,"sawtooth")};E.SawOsc.prototype=Object.create(E.Oscillator.prototype);E.SqrOsc=function(L){E.Oscillator.call(this,L,"square")};E.SqrOsc.prototype=Object.create(E.Oscillator.prototype)}(n,l,g,c,h);var y;y=function(){var L=n;var H=g;var J=c;var G=h;var I=D;I.setContext(L.audiocontext);var F=null;var K=false;E.Env=function(R,N,Q,M,P,T,O,S){this.aTime=R;this.aLevel=N;this.dTime=Q||0;this.dLevel=M||0;this.sTime=P||0;this.sLevel=T||0;this.rTime=O||0;this.rLevel=S||0;this.output=L.audiocontext.createGain();this.control=new E.Signal();this.control.connect(this.output);this.connection=null;this.mathOps=[this.control];L.soundArray.push(this)};E.Env.prototype.set=function(R,N,Q,M,P,T,O,S){this.aTime=R;this.aLevel=N;this.dTime=Q||0;this.dLevel=M||0;this.sTime=P||0;this.sLevel=T||0;this.rTime=O||0;this.rLevel=S||0};E.Env.prototype.setInput=function(N){for(var M=0;M<arguments.length;M++){this.connect(arguments[M])}};E.Env.prototype.ctrl=function(M){this.connect(M)};E.Env.prototype.play=function(S,M){var P=L.audiocontext.currentTime;var R=M||0;var Q=P+R;if(S){if(this.connection!==S){this.connect(S)}}var O=this.control.getValue();this.control.cancelScheduledValues(Q);this.control.linearRampToValueAtTime(O,Q);this.control.linearRampToValueAtTime(this.aLevel,Q+this.aTime);this.control.linearRampToValueAtTime(this.dLevel,Q+this.aTime+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,Q+this.aTime+this.dTime+this.sTime);this.control.linearRampToValueAtTime(this.rLevel,Q+this.aTime+this.dTime+this.sTime+this.rTime);var N=Q+this.aTime+this.dTime+this.sTime+this.rTime};E.Env.prototype.triggerAttack=function(R,M){var O=L.audiocontext.currentTime;var Q=M||0;var P=O+Q;this.lastAttack=P;K=true;var N=this.control.getValue();console.log(N);this.control.cancelScheduledValues(P);this.control.linearRampToValueAtTime(N,P);if(R){if(this.connection!==R){this.connect(R)}}this.control.linearRampToValueAtTime(this.aLevel,P+this.aTime);this.control.linearRampToValueAtTime(this.aLevel,P+this.aTime);this.control.linearRampToValueAtTime(this.dLevel,P+this.aTime+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,P+this.aTime+this.dTime+this.sTime)};E.Env.prototype.triggerRelease=function(S,V){if(!K){return}var N=L.audiocontext.currentTime;var O=V||0;var T=N+O;var M;if(S){if(this.connection!==S){this.connect(S)}}this.control.cancelScheduledValues(T);if(N-this.lastAttack<this.aTime){var R=this.aTime-(T-this.lastAttack);this.control.linearRampToValueAtTime(this.aLevel,T+R);this.control.linearRampToValueAtTime(this.dLevel,T+R+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,T+R+this.dTime+this.sTime);this.control.linearRampToValueAtTime(this.rLevel,T+R+this.dTime+this.sTime+this.rTime);M=T+this.dTime+this.sTime+this.rTime}else{if(N-this.lastAttack<this.aTime+this.dTime){var P=this.aTime+this.dTime-(N-this.lastAttack);this.control.linearRampToValueAtTime(this.dLevel,T+P);this.control.linearRampToValueAtTime(this.sLevel,T+P+0.01);this.control.linearRampToValueAtTime(this.rLevel,T+P+0.01+this.rTime);M=T+this.sTime+this.rTime}else{if(N-this.lastAttack<this.aTime+this.dTime+this.sTime){var U=this.aTime+this.dTime+this.sTime-(N-this.lastAttack);this.control.linearRampToValueAtTime(this.sLevel,T+U);this.control.linearRampToValueAtTime(this.rLevel,T+U+this.rTime);M=T+this.rTime}else{this.control.linearRampToValueAtTime(this.sLevel,T);this.control.linearRampToValueAtTime(this.rLevel,T+this.rTime);M=T+this.dTime+this.sTime+this.rTime}}}var Q=T+this.aTime+this.dTime+this.sTime+this.rTime;if(this.connection&&this.connection.hasOwnProperty("oscillator")){F=this.connection.oscillator;F.stop(Q+0.01)}else{if(this.connect&&this.connection.hasOwnProperty("source")){F=this.connection.source;F.stop(Q+0.01)}}K=false};E.Env.prototype.connect=function(M){this.connection=M;if(M instanceof E.Oscillator||M instanceof E.SoundFile||M instanceof E.AudioIn||M instanceof E.Reverb||M instanceof E.Noise||M instanceof E.Filter||M instanceof E.Delay){M=M.output.gain}if(M instanceof AudioParam){M.setValueAtTime(0,L.audiocontext.currentTime)}if(M instanceof E.Signal){M.setValue(0)}this.output.connect(M)};E.Env.prototype.disconnect=function(M){this.output.disconnect()};E.Env.prototype.add=function(N){var O=new H(N);var P=this.mathOps.length;var M=this.output;return E.prototype._mathChain(this,O,P,M,H)};E.Env.prototype.mult=function(N){var O=new J(N);var P=this.mathOps.length;var M=this.output;return E.prototype._mathChain(this,O,P,M,J)};E.Env.prototype.scale=function(O,S,N,R){var Q=new G(O,S,N,R);var P=this.mathOps.length;var M=this.output;return E.prototype._mathChain(this,Q,P,M,G)};E.Env.prototype.dispose=function(){var M=L.audiocontext.currentTime;this.disconnect();try{this.control.dispose();this.control=null}catch(O){}for(var N=1;N<this.mathOps.length;N++){mathOps[N].dispose()}}}(n,g,c,h,D);var f;f=function(){var G=n;E.Pulse=function(I,H){E.Oscillator.call(this,I,"sawtooth");this.w=H||0;this.osc2=new E.SawOsc(I);this.dNode=G.audiocontext.createDelay();this.dcOffset=F();this.dcGain=G.audiocontext.createGain();this.dcOffset.connect(this.dcGain);this.dcGain.connect(this.output);this.f=I||440;var J=this.w/this.oscillator.frequency.value;this.dNode.delayTime.value=J;this.dcGain.gain.value=1.7*(0.5-this.w);this.osc2.disconnect();this.osc2.panner.disconnect();this.osc2.amp(-1);this.osc2.output.connect(this.dNode);this.dNode.connect(this.output);this.output.gain.value=1;this.output.connect(this.panner)};E.Pulse.prototype=Object.create(E.Oscillator.prototype);E.Pulse.prototype.width=function(H){if(typeof H==="number"){if(H<=1&&H>=0){this.w=H;var J=this.w/this.oscillator.frequency.value;this.dNode.delayTime.value=J}this.dcGain.gain.value=1.7*(0.5-this.w)}else{H.connect(this.dNode.delayTime);var I=new E.SignalAdd(-0.5);I.setInput(H);I=I.mult(-1);I=I.mult(1.7);I.connect(this.dcGain.gain)}};E.Pulse.prototype.start=function(K,M){var H=G.audiocontext.currentTime;var I=M||0;if(!this.started){var L=K||this.f;var J=this.oscillator.type;this.oscillator=G.audiocontext.createOscillator();this.oscillator.frequency.setValueAtTime(L,H);this.oscillator.type=J;this.oscillator.connect(this.output);this.oscillator.start(I+H);this.osc2.oscillator=G.audiocontext.createOscillator();this.osc2.oscillator.frequency.setValueAtTime(L,I+H);this.osc2.oscillator.type=J;this.osc2.oscillator.connect(this.osc2.output);this.osc2.start(I+H);this.freqNode=[this.oscillator.frequency,this.osc2.oscillator.frequency];this.dcOffset=F();this.dcOffset.connect(this.dcGain);this.dcOffset.start(I+H);if(this.mods!==undefined&&this.mods.frequency!==undefined){this.mods.frequency.connect(this.freqNode[0]);this.mods.frequency.connect(this.freqNode[1])}this.started=true;this.osc2.started=true}};E.Pulse.prototype.stop=function(J){if(this.started){var I=J||0;var H=G.audiocontext.currentTime;this.oscillator.stop(I+H);this.osc2.oscillator.stop(I+H);this.dcOffset.stop(I+H);this.started=false;this.osc2.started=false}};E.Pulse.prototype.freq=function(K,L,J){if(typeof K==="number"){this.f=K;var H=G.audiocontext.currentTime;var L=L||0;var J=J||0;var I=this.oscillator.frequency.value;this.oscillator.frequency.cancelScheduledValues(H);this.oscillator.frequency.setValueAtTime(I,H+J);this.oscillator.frequency.exponentialRampToValueAtTime(K,J+L+H);this.osc2.oscillator.frequency.cancelScheduledValues(H);this.osc2.oscillator.frequency.setValueAtTime(I,H+J);this.osc2.oscillator.frequency.exponentialRampToValueAtTime(K,J+L+H);if(this.freqMod){this.freqMod.output.disconnect();this.freqMod=null}}else{if(K.output){K.output.disconnect();K.output.connect(this.oscillator.frequency);K.output.connect(this.osc2.oscillator.frequency);this.freqMod=K}}};function F(){var J=G.audiocontext;var H=J.createBuffer(1,2048,J.sampleRate);var K=H.getChannelData(0);for(var I=0;I<2048;I++){K[I]=1}var L=J.createBufferSource();L.buffer=H;L.loop=true;return L}}(n,v);var p;p=function(){var I=n;E.Noise=function(J){E.Oscillator.call(this);delete this.f;delete this.freq;delete this.oscillator;this.buffer=G};E.Noise.prototype=Object.create(E.Oscillator.prototype);var G=function(){var M=2*I.audiocontext.sampleRate;var J=I.audiocontext.createBuffer(1,M,I.audiocontext.sampleRate);var L=J.getChannelData(0);for(var K=0;K<M;K++){L[K]=Math.random()*2-1}J.type="white";return J}();var F=function(){var K=2*I.audiocontext.sampleRate;var J=I.audiocontext.createBuffer(1,K,I.audiocontext.sampleRate);var U=J.getChannelData(0);var T,S,R,Q,P,O,M;T=S=R=Q=P=O=M=0;for(var L=0;L<K;L++){var N=Math.random()*2-1;T=0.99886*T+N*0.0555179;S=0.99332*S+N*0.0750759;R=0.969*R+N*0.153852;Q=0.8665*Q+N*0.3104856;P=0.55*P+N*0.5329522;O=-0.7616*O-N*0.016898;U[L]=T+S+R+Q+P+O+M+N*0.5362;U[L]*=0.11;M=N*0.115926}J.type="pink";return J}();var H=function(){var O=2*I.audiocontext.sampleRate;var M=I.audiocontext.createBuffer(1,O,I.audiocontext.sampleRate);var N=M.getChannelData(0);var J=0;for(var L=0;L<O;L++){var K=Math.random()*2-1;N[L]=(J+0.02*K)/1.02;J=N[L];N[L]*=3.5}M.type="brown";return M}();E.Noise.prototype.setType=function(K){switch(K){case"white":this.buffer=G;break;case"pink":this.buffer=F;break;case"brown":this.buffer=H;break;default:this.buffer=G}if(this.started){var J=I.audiocontext.currentTime;this.stop(J);this.start(J+0.01)}};E.Noise.prototype.getType=function(){return this.buffer.type};E.Noise.prototype.start=function(){if(this.started){this.stop()}this.noise=I.audiocontext.createBufferSource();this.noise.buffer=this.buffer;this.noise.loop=true;this.noise.connect(this.output);var J=I.audiocontext.currentTime;this.noise.start(J);this.started=true};E.Noise.prototype.stop=function(){var J=I.audiocontext.currentTime;if(this.noise){this.noise.stop(J);this.started=false}};E.Noise.prototype.dispose=function(){var J=I.audiocontext.currentTime;if(this.noise){this.noise.disconnect();this.stop(J)}if(this.output){this.output.disconnect()}if(this.panner){this.panner.disconnect()}this.output=null;this.panner=null;this.buffer=null;this.noise=null}}(n);var e;e=function(){var F=n;E.AudioIn=function(){this.input=F.audiocontext.createGain();this.output=F.audiocontext.createGain();this.stream=null;this.mediaStream=null;this.currentSource=0;this.enabled=false;this.amplitude=new E.Amplitude();this.output.connect(this.amplitude.input);if(typeof window.MediaStreamTrack==="undefined"){window.alert("This browser does not support MediaStreamTrack")}else{if(typeof window.MediaStreamTrack.getSources==="function"){window.MediaStreamTrack.getSources(this._gotSources)}else{}}F.soundArray.push(this)};E.AudioIn.prototype.start=function(){var G=this;if(F.inputSources[G.currentSource]){var H=F.inputSources[G.currentSource].id;var I={audio:{optional:[{sourceId:H}]}};navigator.getUserMedia(I,this._onStream=function(J){G.stream=J;G.enabled=true;G.mediaStream=F.audiocontext.createMediaStreamSource(J);G.mediaStream.connect(G.output);G.amplitude.setInput(G.output)},this._onStreamError=function(J){console.error(J)})}else{window.navigator.getUserMedia({audio:true},this._onStream=function(J){G.stream=J;G.enabled=true;G.mediaStream=F.audiocontext.createMediaStreamSource(J);G.mediaStream.connect(G.output);G.amplitude.setInput(G.output)},this._onStreamError=function(J){console.error(J)})}};E.AudioIn.prototype.stop=function(){if(this.stream){this.stream.stop()}};E.AudioIn.prototype.connect=function(G){if(G){if(G.hasOwnProperty("input")){this.output.connect(G.input)}else{if(G.hasOwnProperty("analyser")){this.output.connect(G.analyser)}else{this.output.connect(G)}}}else{this.output.connect(F.input)}};E.AudioIn.prototype.disconnect=function(G){this.output.disconnect(G);this.output.connect(this.amplitude.input)};E.AudioIn.prototype.getLevel=function(G){if(G){this.amplitude.smoothing=G}return this.amplitude.getLevel()};E.AudioIn.prototype._gotSources=function(H){for(var G=0;G<H.length;G++){var I=H[G];if(I.kind==="audio"){return I}}};E.AudioIn.prototype.amp=function(H,G){if(G){var J=G||0;var I=this.output.gain.value;this.output.gain.cancelScheduledValues(F.audiocontext.currentTime);this.output.gain.setValueAtTime(I,F.audiocontext.currentTime);this.output.gain.linearRampToValueAtTime(H,J+F.audiocontext.currentTime)}else{this.output.gain.cancelScheduledValues(F.audiocontext.currentTime);this.output.gain.setValueAtTime(H,F.audiocontext.currentTime)}};E.AudioIn.prototype.listSources=function(){console.log("listSources is deprecated - please use AudioIn.getSources");console.log("input sources: ");if(F.inputSources.length>0){return F.inputSources}else{return"This browser does not support MediaStreamTrack.getSources()"}};E.AudioIn.prototype.getSources=function(G){if(typeof window.MediaStreamTrack.getSources==="function"){window.MediaStreamTrack.getSources(function(K){for(var I=0,H=K.length;I<H;I++){var J=K[I];if(J.kind==="audio"){F.inputSources.push(J)}}G(F.inputSources)})}else{console.log("This browser does not support MediaStreamTrack.getSources()")}};E.AudioIn.prototype.setSource=function(H){var G=this;if(F.inputSources.length>0&&H<F.inputSources.length){G.currentSource=H;console.log("set source to "+F.inputSources[G.currentSource].id)}else{console.log("unable to set input source")}};E.AudioIn.prototype.dispose=function(){this.stop();if(this.output){this.output.disconnect()}if(this.amplitude){this.amplitude.disconnect()}this.amplitude=null;this.output=null}}(n);var m;m=function(){var F=n;E.Filter=function(G){this.ac=F.audiocontext;this.input=this.ac.createGain();this.output=this.ac.createGain();this.biquad=this.ac.createBiquadFilter();this.input.connect(this.biquad);this.biquad.connect(this.output);this.connect();if(G){this.setType(G)}};E.Filter.prototype.process=function(I,H,G){I.connect(this.input);this.set(H,G)};E.Filter.prototype.set=function(I,G,H){if(I){this.freq(I,H)}if(G){this.res(G,H)}};E.Filter.prototype.freq=function(J,I){var G=this;var H=I||0;if(J<=0){J=1}if(typeof J==="number"){G.biquad.frequency.value=J;G.biquad.frequency.cancelScheduledValues(this.ac.currentTime+0.01+H);G.biquad.frequency.exponentialRampToValueAtTime(J,this.ac.currentTime+0.02+H)}else{if(J){J.connect(this.biquad.frequency)}}return G.biquad.frequency.value};E.Filter.prototype.res=function(I,J){var G=this;var H=J||0;if(typeof I=="number"){G.biquad.Q.value=I;G.biquad.Q.cancelScheduledValues(G.ac.currentTime+0.01+H);G.biquad.Q.linearRampToValueAtTime(I,G.ac.currentTime+0.02+H)}else{if(I){freq.connect(this.biquad.Q)}}return G.biquad.Q.value};E.Filter.prototype.setType=function(G){this.biquad.type=G};E.Filter.prototype.amp=function(H,K,I){var K=K||0;var I=I||0;var G=F.audiocontext.currentTime;var J=this.output.gain.value;this.output.gain.cancelScheduledValues(G);this.output.gain.linearRampToValueAtTime(J,G+I+0.001);this.output.gain.linearRampToValueAtTime(H,G+I+K+0.001)};E.Filter.prototype.connect=function(H){var G=H||E.soundOut.input;this.output.connect(G)};E.Filter.prototype.disconnect=function(){this.output.disconnect()};E.LowPass=function(){E.Filter.call(this,"lowpass")};E.LowPass.prototype=Object.create(E.Filter.prototype);E.HighPass=function(){E.Filter.call(this,"highpass")};E.HighPass.prototype=Object.create(E.Filter.prototype);E.BandPass=function(){E.Filter.call(this,"bandpass")};E.BandPass.prototype=Object.create(E.Filter.prototype)}(n);var C;C=function(){var G=n;var F=m;E.Delay=function(){this.ac=G.audiocontext;this.input=this.ac.createGain();this.output=this.ac.createGain();this._split=this.ac.createChannelSplitter(2);this._merge=this.ac.createChannelMerger(2);this._leftGain=this.ac.createGain();this._rightGain=this.ac.createGain();this.leftDelay=this.ac.createDelay();this.rightDelay=this.ac.createDelay();this._leftFilter=new E.Filter();this._rightFilter=new E.Filter();this._leftFilter.disconnect();this._rightFilter.disconnect();this.lowPass=this._leftFilter;this._leftFilter.biquad.frequency.setValueAtTime(1200,this.ac.currentTime);this._rightFilter.biquad.frequency.setValueAtTime(1200,this.ac.currentTime);this._leftFilter.biquad.Q.setValueAtTime(0.3,this.ac.currentTime);this._rightFilter.biquad.Q.setValueAtTime(0.3,this.ac.currentTime);this.input.connect(this._split);this.leftDelay.connect(this._leftGain);this.rightDelay.connect(this._rightGain);this._leftGain.connect(this._leftFilter.input);this._rightGain.connect(this._rightFilter.input);this._merge.connect(this.output);this.output.connect(E.soundOut.input);this._leftFilter.biquad.gain.setValueAtTime(1,this.ac.currentTime);this._rightFilter.biquad.gain.setValueAtTime(1,this.ac.currentTime);this.setType(0);this._maxDelay=this.leftDelay.delayTime.maxValue};E.Delay.prototype.process=function(M,H,J,L){var I=J||0;var K=H||0;if(I>=1){throw new Error("Feedback value will force a positive feedback loop.")}if(K>=this._maxDelay){throw new Error("Delay Time exceeds maximum delay time of "+this._maxDelay+" second.")}M.connect(this.input);this.leftDelay.delayTime.setValueAtTime(K,this.ac.currentTime);this.rightDelay.delayTime.setValueAtTime(K,this.ac.currentTime);this._leftGain.gain.setValueAtTime(I,this.ac.currentTime);this._rightGain.gain.setValueAtTime(I,this.ac.currentTime);if(L){this._leftFilter.freq(L);this._rightFilter.freq(L)}};E.Delay.prototype.delayTime=function(H){if(typeof H!=="number"){H.connect(this.leftDelay.delayTime);H.connect(this.rightDelay.delayTime)}else{this.leftDelay.delayTime.cancelScheduledValues(this.ac.currentTime);this.rightDelay.delayTime.cancelScheduledValues(this.ac.currentTime);this.leftDelay.delayTime.linearRampToValueAtTime(H,this.ac.currentTime);this.rightDelay.delayTime.linearRampToValueAtTime(H,this.ac.currentTime)}};E.Delay.prototype.feedback=function(H){if(typeof H!=="number"){H.connect(this._leftGain.gain);H.connect(this._rightGain.gain)}else{if(H>=1){throw new Error("Feedback value will force a positive feedback loop.")}else{this._leftGain.gain.exponentialRampToValueAtTime(H,this.ac.currentTime);this._rightGain.gain.exponentialRampToValueAtTime(H,this.ac.currentTime)}}};E.Delay.prototype.filter=function(I,H){this._leftFilter.set(I,H);this._rightFilter.set(I,H)};E.Delay.prototype.setType=function(H){if(H===1){H="pingPong"}this._split.disconnect();this._leftFilter.disconnect();this._rightFilter.disconnect();this._split.connect(this.leftDelay,0);this._split.connect(this.rightDelay,1);switch(H){case"pingPong":this._rightFilter.setType(this._leftFilter.biquad.type);this._leftFilter.output.connect(this._merge,0,0);this._rightFilter.output.connect(this._merge,0,1);this._leftFilter.output.connect(this.rightDelay);this._rightFilter.output.connect(this.leftDelay);break;default:this._leftFilter.output.connect(this._merge,0,0);this._leftFilter.output.connect(this._merge,0,1);this._leftFilter.output.connect(this.leftDelay);this._leftFilter.output.connect(this.rightDelay)}};E.Delay.prototype.amp=function(I,L,J){var L=L||0;var J=J||0;var H=G.audiocontext.currentTime;var K=this.output.gain.value;this.output.gain.cancelScheduledValues(H);this.output.gain.linearRampToValueAtTime(K,H+J+0.001);this.output.gain.linearRampToValueAtTime(I,H+J+L+0.001)};E.Delay.prototype.connect=function(I){var H=I||E.soundOut.input;this.output.connect(H)};E.Delay.prototype.disconnect=function(){this.output.disconnect()}}(n,m);var o;o=function(){var F=n;E.Reverb=function(){this.ac=F.audiocontext;this.convolverNode=this.ac.createConvolver();this.input=this.ac.createGain();this.output=this.ac.createGain();this.input.gain.value=0.5;this.input.connect(this.convolverNode);this.convolverNode.connect(this.output);this._seconds=3;this._decay=2;this._reverse=false;this._buildImpulse();this.connect();F.soundArray.push(this)};E.Reverb.prototype.process=function(K,J,I,H){K.connect(this.input);var G=false;if(J){this._seconds=J;G=true}if(I){this._decay=I}if(H){this._reverse=H}if(G){this._buildImpulse()}};E.Reverb.prototype.set=function(J,I,H){var G=false;if(J){this._seconds=J;G=true}if(I){this._decay=I}if(H){this._reverse=H}if(G){this._buildImpulse()}};E.Reverb.prototype.amp=function(H,K,I){var K=K||0;var I=I||0;var G=F.audiocontext.currentTime;var J=this.output.gain.value;this.output.gain.cancelScheduledValues(G);this.output.gain.linearRampToValueAtTime(J,G+I+0.001);this.output.gain.linearRampToValueAtTime(H,G+I+K+0.001)};E.Reverb.prototype.connect=function(H){var G=H||E.soundOut.input;this.output.connect(G.input?G.input:G)};E.Reverb.prototype.disconnect=function(){this.output.disconnect()};E.Reverb.prototype._buildImpulse=function(){var I=this.ac.sampleRate;var K=I*this._seconds;var J=this._decay;var M=this.ac.createBuffer(2,K,I);var G=M.getChannelData(0);var L=M.getChannelData(1);var N,H;for(H=0;H<K;H++){N=this.reverse?K-H:H;G[H]=(Math.random()*2-1)*Math.pow(1-N/K,J);L[H]=(Math.random()*2-1)*Math.pow(1-N/K,J)}this.convolverNode.buffer=M};E.Reverb.prototype.dispose=function(){if(this.convolverNode){this.convolverNode.buffer=null;this.convolverNode=null}if(typeof this.output!=="undefined"){this.output.disconnect();this.output=null}if(typeof this.panner!=="undefined"){this.panner.disconnect();this.panner=null}};E.Convolver=function(G,H){this.ac=F.audiocontext;this.convolverNode=this.ac.createConvolver();this.input=this.ac.createGain();this.output=this.ac.createGain();this.input.gain.value=0.5;this.input.connect(this.convolverNode);this.convolverNode.connect(this.output);if(G){this.impulses=[];this._loadBuffer(G,H)}else{this._seconds=3;this._decay=2;this._reverse=false;this._buildImpulse()}this.connect();F.soundArray.push(this)};E.Convolver.prototype=Object.create(E.Reverb.prototype);E.prototype.registerPreloadMethod("createConvolver",E.prototype);E.prototype.createConvolver=function(H,I){if(window.location.origin.indexOf("file://")>-1&&window.cordova==="undefined"){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}var G=new E.Convolver(H,I);G.impulses=[];return G};E.Convolver.prototype._loadBuffer=function(I,J){I=E.prototype._checkFileFormats(I);var H=new XMLHttpRequest();H.open("GET",I,true);H.responseType="arraybuffer";var G=this;H.onload=function(){var K=E.prototype.getAudioContext();K.decodeAudioData(H.response,function(N){var L={};var M=I.split("/");L.name=M[M.length-1];L.audioBuffer=N;G.impulses.push(L);G.convolverNode.buffer=L.audioBuffer;if(J){J(L)}})};H.send()};E.Convolver.prototype.set=null;E.Convolver.prototype.process=function(G){G.connect(this.input)};E.Convolver.prototype.impulses=[];E.Convolver.prototype.addImpulse=function(G,H){if(window.location.origin.indexOf("file://")>-1&&window.cordova==="undefined"){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}this._loadBuffer(G,H)};E.Convolver.prototype.resetImpulse=function(G,H){if(window.location.origin.indexOf("file://")>-1&&window.cordova==="undefined"){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}this.impulses=[];this._loadBuffer(G,H)};E.Convolver.prototype.toggleImpulse=function(H){if(typeof H==="number"&&H<this.impulses.length){this.convolverNode.buffer=this.impulses[H].audioBuffer}if(typeof H==="string"){for(var G=0;G<this.impulses.length;G++){if(this.impulses[G].name===H){this.convolverNode.buffer=this.impulses[G].audioBuffer;break}}}};E.Convolver.prototype.dispose=function(){for(var G in this.impulses){this.impulses[G]=null}this.convolverNode.disconnect();this.concolverNode=null;if(typeof this.output!=="undefined"){this.output.disconnect();this.output=null}if(typeof this.panner!=="undefined"){this.panner.disconnect();this.panner=null}}}(n,r);var q;q=function(F){F.Clock=function(G,H){this._oscillator=null;this._jsNode=this.context.createScriptProcessor(this.bufferSize,1,1);this._jsNode.onaudioprocess=this._processBuffer.bind(this);this._controlSignal=new F.Signal(1);this._upTick=false;this.tick=this.defaultArg(H,function(){});this._jsNode.noGC();this.setRate(G)};F.extend(F.Clock);F.Clock.prototype.setRate=function(G,I){var H=this.secondsToFrequency(this.toSeconds(G));if(!I){this._controlSignal.cancelScheduledValues(0);this._controlSignal.setValue(H)}else{this._controlSignal.exponentialRampToValueNow(H,I)}};F.Clock.prototype.getRate=function(){return this._controlSignal.getValue()};F.Clock.prototype.start=function(H){this._oscillator=this.context.createOscillator();this._oscillator.type="square";this._oscillator.connect(this._jsNode);this._controlSignal.connect(this._oscillator.frequency);this._upTick=false;var G=this.toSeconds(H);this._oscillator.start(G);this._oscillator.onended=function(){}};F.Clock.prototype.stop=function(I,H){var G=this.toSeconds(I);this._oscillator.onended=H;this._oscillator.stop(G)};F.Clock.prototype._processBuffer=function(L){var H=this.defaultArg(L.playbackTime,this.now());var N=this._jsNode.bufferSize;var K=L.inputBuffer.getChannelData(0);var M=this._upTick;var G=this;for(var I=0;I<N;I++){var J=K[I];if(J>0&&!M){M=true;setTimeout(function(){var O=H+G.samplesToSeconds(I+N*2);return function(){G.tick(O)}}(),0)}else{if(J<0&&M){M=false}}}this._upTick=M};F.Clock.prototype.dispose=function(){this._jsNode.disconnect();this._controlSignal.dispose();if(this._oscillator){this._oscillator.onended();this._oscillator.disconnect()}this._jsNode.onaudioprocess=function(){};this._jsNode=null;this._controlSignal=null;this._oscillator=null};return F.Clock}(D);var B;B=function(){var H=n;var J=q;var F=H.audiocontext;E.Metro=function(){this.clock=new J(F.sampleRate,this.ontick.bind(this));this.syncedParts=[];this.bpm=120;this._init();this.tickCallback=function(){}};var I=0;var G=0;E.Metro.prototype.ontick=function(P){var R=P-I;var S=P-H.audiocontext.currentTime;if(R-G<=-0.02){return}else{I=P;for(var N in this.syncedParts){var L=this.syncedParts[N];L.incrementStep(S);for(var M in L.phrases){var O=L.phrases[M];var K=O.sequence;var Q=this.metroTicks%K.length;if(K[Q]!==0&&(this.metroTicks<K.length||!O.looping)){O.callback(S,K[Q])}}}this.metroTicks+=1;this.tickCallback(S)}};E.Metro.prototype.setBPM=function(M,N){var L=60/(M*this.tatums);G=L;var K=N||0;this.clock.setRate(L,N+H.audiocontext.currentTime);this.bpm=M};E.Metro.prototype.getBPM=function(K){return this.clock.getRate()/this.tatums*60};E.Metro.prototype._init=function(){this.metroTicks=0};E.Metro.prototype.resetSync=function(K){this.syncedParts=[K]};E.Metro.prototype.pushSync=function(K){this.syncedParts.push(K)};E.Metro.prototype.start=function(L){var K=L||0;this.clock.start(K);this.setBPM(this.bpm)};E.Metro.prototype.stop=function(L){var K=L||0;if(this.clock._oscillator){this.clock.stop(K)}};E.Metro.prototype.beatLength=function(K){this.tatums=1/K/4}}(n,q);var a;a=function(){var H=n;var G=120;E.prototype.setBPM=function(J,K){G=J;for(var I in H.parts){H.parts[I].setBPM(G,K)}};E.Phrase=function(I,K,J){this.phraseStep=0;this.name=I;this.callback=K;this.sequence=J};E.Part=function(I,J){this.length=I||0;this.partStep=0;this.phrases=[];this.looping=false;this.isPlaying=false;this.onended=function(){this.stop()};this.tatums=J||0.0625;this.metro=new E.Metro();this.metro._init();this.metro.beatLength(this.tatums);this.metro.setBPM(G);H.parts.push(this);this.callback=function(){}};E.Part.prototype.setBPM=function(I,J){this.metro.setBPM(I,J)};E.Part.prototype.getBPM=function(){return this.metro.getBPM()};E.Part.prototype.start=function(J){if(!this.isPlaying){this.isPlaying=true;this.metro.resetSync(this);var I=J||0;this.metro.start(I)}};E.Part.prototype.loop=function(J){this.looping=true;this.onended=function(){this.partStep=0};var I=J||0;this.start(I)};E.Part.prototype.noLoop=function(){this.looping=false;this.onended=function(){this.stop()}};E.Part.prototype.stop=function(I){this.partStep=0;this.pause(I)};E.Part.prototype.pause=function(J){this.isPlaying=false;var I=J||0;this.metro.stop(I)};E.Part.prototype.addPhrase=function(I,L,K){var J;if(arguments.length===3){J=new E.Phrase(I,L,K)}else{if(arguments[0] instanceof E.Phrase){J=arguments[0]}else{throw"invalid input. addPhrase accepts name, callback, array or a p5.Phrase"}}this.phrases.push(J);if(J.sequence.length>this.length){this.length=J.sequence.length}};E.Part.prototype.removePhrase=function(I){for(var J in this.phrases){if(this.phrases[J].name===I){this.phrases.split(J,1)}}};E.Part.prototype.getPhrase=function(I){for(var J in this.phrases){if(this.phrases[J].name===I){return this.phrases[J]}}};E.Part.prototype.replaceSequence=function(I,K){for(var J in this.phrases){if(this.phrases[J].name===I){this.phrases[J].sequence=K}}};E.Part.prototype.incrementStep=function(I){if(this.partStep<this.length-1){this.callback(I);this.partStep+=1}else{if(this.looping){this.callback(I)}this.onended();this.partStep=0}};E.Part.prototype.onStep=function(I){this.callback=I};E.Score=function(){this.parts=[];this.currentPart=0;var I=this;for(var J in arguments){this.parts[J]=arguments[J];this.parts[J].nextPart=this.parts[J+1];this.parts[J].onended=function(){I.resetPart(J);F(I)}}this.looping=false};E.Score.prototype.onended=function(){if(this.looping){this.parts[0].start()}else{this.parts[this.parts.length-1].onended=function(){this.stop();this.resetParts()}}this.currentPart=0};E.Score.prototype.start=function(){this.parts[this.currentPart].start();this.scoreStep=0};E.Score.prototype.stop=function(){this.parts[this.currentPart].stop();this.currentPart=0;this.scoreStep=0};E.Score.prototype.pause=function(){this.parts[this.currentPart].stop()};E.Score.prototype.loop=function(){this.looping=true;this.start()};E.Score.prototype.noLoop=function(){this.looping=false};E.Score.prototype.resetParts=function(){for(var I in this.parts){this.resetPart(I)}};E.Score.prototype.resetPart=function(I){this.parts[I].stop();this.parts[I].partStep=0;for(var J in this.parts[I].phrases){this.parts[I].phrases[J].phraseStep=0}};E.Score.prototype.setBPM=function(J,K){for(var I in this.parts){this.parts[I].setBPM(J,K)}};function F(I){I.currentPart++;if(I.currentPart>=I.parts.length){I.scoreStep=0;I.onended()}else{I.scoreStep=0;I.parts[I.currentPart-1].stop();I.parts[I.currentPart].start()}}}(n);var u;u=function(){var I=n;var H=I.audiocontext;E.SoundRecorder=function(){this.input=H.createGain();this.output=H.createGain();this.recording=false;this.bufferSize=1024;this._channels=2;this._clear();this._jsNode=H.createScriptProcessor(this.bufferSize,this._channels,2);this._jsNode.onaudioprocess=this._audioprocess.bind(this);this._callback=function(){};this._jsNode.connect(E.soundOut._silentNode);this.setInput();I.soundArray.push(this)};E.SoundRecorder.prototype.setInput=function(J){this.input.disconnect();this.input=null;this.input=H.createGain();this.input.connect(this._jsNode);this.input.connect(this.output);if(J){J.connect(this.input)}else{E.soundOut.output.connect(this.input)}};E.SoundRecorder.prototype.record=function(K,J,L){this.recording=true;if(J){this.sampleLimit=Math.round(J*H.sampleRate)}if(K&&L){this._callback=function(){this.buffer=this._getBuffer();K.setBuffer(this.buffer);L()}}else{if(K){this._callback=function(){this.buffer=this._getBuffer();K.setBuffer(this.buffer)}}}};E.SoundRecorder.prototype.stop=function(){this.recording=false;this._callback();this._clear()};E.SoundRecorder.prototype._clear=function(){this._leftBuffers=[];this._rightBuffers=[];this.recordedSamples=0;this.sampleLimit=null};E.SoundRecorder.prototype._audioprocess=function(K){if(this.recording===false){return}else{if(this.recording===true){if(this.sampleLimit&&this.recordedSamples>=this.sampleLimit){this.stop()}else{var L=K.inputBuffer.getChannelData(0);var J=K.inputBuffer.getChannelData(1);this._leftBuffers.push(new Float32Array(L));this._rightBuffers.push(new Float32Array(J));this.recordedSamples+=this.bufferSize}}}};E.SoundRecorder.prototype._getBuffer=function(){var J=[];J.push(this._mergeBuffers(this._leftBuffers));J.push(this._mergeBuffers(this._rightBuffers));return J};E.SoundRecorder.prototype._mergeBuffers=function(N){var J=new Float32Array(this.recordedSamples);var O=0;var L=N.length;for(var M=0;M<L;M++){var K=N[M];J.set(K,O);O+=K.length}return J};E.SoundRecorder.prototype.dispose=function(){this._clear();this._callback=function(){};if(this.input){this.input.disconnect()}this.input=null;this._jsNode=null};E.prototype.saveSound=function(J,K){var Q=J.buffer.getChannelData(0);var L=J.buffer.getChannelData(1);var T=F(Q,L);var M=new ArrayBuffer(44+T.length*2);var S=new DataView(M);G(S,0,"RIFF");S.setUint32(4,44+T.length*2,true);G(S,8,"WAVE");G(S,12,"fmt ");S.setUint32(16,16,true);S.setUint16(20,1,true);S.setUint16(22,2,true);S.setUint32(24,44100,true);S.setUint32(28,44100*4,true);S.setUint16(32,4,true);S.setUint16(34,16,true);G(S,36,"data");S.setUint32(40,T.length*2,true);var R=T.length;var P=44;var O=1;for(var N=0;N<R;N++){S.setInt16(P,T[N]*(32767*O),true);P+=2}E.prototype.writeFile([S],K,"wav")};function F(L,K){var N=L.length+K.length;var J=new Float32Array(N);var O=0;for(var M=0;M<N;){J[M++]=L[O];J[M++]=K[O];O++}return J}function G(J,N,L){var K=L.length;for(var M=0;M<K;M++){J.setUint8(N+M,L.charCodeAt(M))}}}(r,n);var z;z=function(){var F=n;E.PeakDetect=function(K,J,G,I){var H;this.framesPerPeak=I||20;this.framesSinceLastPeak=0;this.decayRate=0.95;this.threshold=G||0.35;this.cutoff=0;this.cutoffMult=1.5;this.energy=0;this.penergy=0;this.currentValue=0;this.isDetected=false;this.f1=K||40;this.f2=J||20000;this._onPeak=function(){}};E.PeakDetect.prototype.update=function(G){var H=this.energy=G.getEnergy(this.f1,this.f2)/255;if(H>this.cutoff&&H>this.threshold&&H-this.penergy>0){this._onPeak();this.isDetected=true;this.cutoff=H*this.cutoffMult;this.framesSinceLastPeak=0}else{this.isDetected=false;if(this.framesSinceLastPeak<=this.framesPerPeak){this.framesSinceLastPeak++}else{this.cutoff*=this.decayRate;this.cutoff=Math.max(this.cutoff,this.threshold)}}this.currentValue=H;this.penergy=H};E.PeakDetect.prototype.onPeak=function(I,H){var G=this;G._onPeak=function(){I(G.energy,H)}}}(n);var k;k=function(){var F=n;E.Gain=function(){this.ac=F.audiocontext;this.input=this.ac.createGain();this.output=this.ac.createGain();this.input.gain.value=0.5;this.input.connect(this.output)};E.Gain.prototype.setInput=function(G){G.connect(this.input)};E.Gain.prototype.connect=function(H){var G=H||E.soundOut.input;this.output.connect(G.input?G.input:G)};E.Gain.prototype.disconnect=function(){this.output.disconnect()};E.Gain.prototype.amp=function(H,K,I){var K=K||0;var I=I||0;var G=F.audiocontext.currentTime;var J=this.output.gain.value;this.output.gain.cancelScheduledValues(G);this.output.gain.linearRampToValueAtTime(J,G+I);this.output.gain.linearRampToValueAtTime(H,G+I+K)}}(n,r);var b;b=function(){var F=r;return F}(r,n,t,x,d,i,s,A,v,y,f,p,e,m,C,o,B,a,u,z,k)}));